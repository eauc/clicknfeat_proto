<div style="vertical-align:top"
     ng-keydown="onKeyDown($event)"
     ng-keypress="onKeyPress($event)"
     tabindex="0"
     >
  <table style="border-collapse:collapse;">
    <tr>
      <td valign="top">
        <div style="
             height: {{game.board.window.height}}px;
             vertical-align: top;
             "
             ng-include="'partials/dock.html'">
        </div>
      </td>
      <td valign="top">
        <div style="
             position:relative;
             width:{{game.board.window.width+5}}px;
             height:{{game.board.window.height+5}}px;
             ">
        <div style="
             position:absolute;
             z-index:2;
             bottom:15;
             left:0;
             "
             ng-include="'partials/viewControls.html'"
             >
        </div>
        <div id="canvas-container"
             style="
             width:{{game.board.window.width+5}}px;
             height:{{game.board.window.height+5}}px;
             overflow: auto;
             ">
        <svg style="
             border:1px solid black;
             display: inline-block;
             margin:0;
             padding:0;
             "
             ng-style="{
             '-moz-transform': game.board.zoom.flipped ? 'scaleX(-1) scaleY(-1)' : '',
             '-webkit-transform': game.board.zoom.flipped ? 'scaleX(-1) scaleY(-1)' : '',
             'transform': game.board.zoom.flipped ? 'scaleX(-1) scaleY(-1)' : ''
             }"
             width="{{game.board.window.width*game.board.zoom.factor}}px"
             height="{{game.board.window.height*game.board.zoom.factor}}px"
             viewBox="0 0 480 480"
             preserveAspectRatio="xMinYMin meet"
             ng-mousedown="doSelectStart($event)"
             ng-mousemove="doSelectMove($event)"
             ng-mouseup="doSelectStop($event)"
             >
          <defs>
            <filter id="aura-filter"
                    x="-50%" y="-50%"
                    width="200%" height="200%">
              <feGaussianBlur in="SourceGraphic"
                              stdDeviation="2"/>
            </filter>
            <marker id="ruler-start"
                    markerWidth="6" markerHeight="8"
                    refx="0" refy="4"
                    orient="auto">
              <polygon points="6,8 0,4 6,0"
                       style="
                       fill:#0CC;
                       "
                       />
              <line x1="0" y1="1" x2="0" y2="7"
                    style="
                    stroke:#0CC;
                    stroke-width:2px;
                    "
                    />
            </marker>
            <marker id="ruler-end"
                    markerWidth="6" markerHeight="8"
                    refx="6" refy="4"
                    orient="auto">
              <polygon points="0,8 6,4 0,0"
                       style="
                       fill:#0CC;
                       "
                       />
              <line x1="6" y1="1" x2="6" y2="7"
                    style="
                    stroke:#0CC;
                    stroke-width:2px;
                    "
                    />
            </marker>
            <marker id="aoe-direction-end"
                    markerWidth="6" markerHeight="8"
                    refx="6" refy="4"
                    orient="auto">
              <polygon points="0,8 6,4 0,0"
                       style="
                       fill:#0F0;
                       "
                       />
            </marker>
          </defs>
          <image id="canvas"
                 x="0" y="0" width="{{game.board.width}}" height="{{game.board.height}}"
                 xlink:href="{{game.board.info.img}}"
                 style="display: {{game.layers.board ? 'inline' : 'none'}}"
                 />
          <svg id="terrain-canvas"
               x="0" y="0" width="{{game.board.width}}" height="{{game.board.height}}"
               style="display: {{game.layers.terrain ? 'inline' : 'none'}}"
               >
            <rect ng-repeat="r in game.board.info.terrain.rect"
                  x="{{r.x-r.width/2}}" y="{{r.y-r.height/2}}"
                  width="{{r.width}}" height="{{r.height}}"
                  transform="rotate({{r.rotate}}, {{r.x}}, {{r.y}})"
                  style="
                  fill-opacity:0.2;
                  "
                  ng-style="{
                  fill: r.type === 'obstruction' ? '#00F' : (r.type === 'linear' ? '#F00' : (r.type === 'forest' ? '#0F0' : (r.type === 'elevation' ? '#0FF' : '#CCC')))
                  }"
                  />
            <circle ng-repeat="c in game.board.info.terrain.circle"
                    cx="{{c.x}}" cy="{{c.y}}" r="{{c.r}}"
                    style="
                    fill-opacity:0.2;
                    "
                    ng-style="{
                    fill: c.type === 'obstruction' ? '#00F' : (c.type === 'linear' ? '#F00' : (c.type === 'forest' ? '#0F0' : (c.type === 'elevation' ? '#0FF' : '#CCC')))
                    }"
                    />
          </svg>
          <svg x="0" y="0" width="{{game.board.width}}" height="{{game.board.height}}"
               style="display: {{game.layers.deployment ? 'inline' : 'none'}}"
               >
            <line x1="0" y1="70"
                  x2="480" y2="70"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  "
                  />
            <rect x="0" y="58"
                  width="20" height="12"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="69"
                  style="
                  font-size:12px;
                  "
                  >7"</text>
            <line x1="0" y1="130"
                  x2="480" y2="130"
                  style="
                  stroke:#000;
                  stroke-width:0.5px;
                  "
                  />
            <rect x="0" y="122"
                  width="15" height="8"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="129"
                  style="
                  font-size:8px;
                  "
                  >13"</text>

            <line x1="0" y1="100"
                  x2="480" y2="100"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  "
                  />
            <rect x="0" y="88"
                  width="20" height="12"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="99"
                  style="
                  font-size:12px;
                  "
                  >10"</text>
            <line x1="0" y1="160"
                  x2="480" y2="160"
                  style="
                  stroke:#000;
                  stroke-width:0.5px;
                  "
                  />
            <rect x="0" y="152"
                  width="15" height="8"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="159"
                  style="
                  font-size:8px;
                  "
                  >16"</text>

            <line x1="0" y1="380"
                  x2="480" y2="380"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  "
                  />
            <rect x="0" y="368"
                  width="20" height="12"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="379"
                  style="
                  font-size:12px;
                  "
                  >10"</text>
            <line x1="0" y1="320"
                  x2="480" y2="320"
                  style="
                  stroke:#000;
                  stroke-width:0.5px;
                  "
                  />
            <rect x="0" y="312"
                  width="15" height="8"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="319"
                  style="
                  font-size:8px;
                  "
                  >16"</text>

            <line x1="0" y1="410"
                  x2="480" y2="410"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  "
                  />
            <rect x="0" y="398"
                  width="20" height="12"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="409"
                  style="
                  font-size:12px;
                  "
                  >7"</text>
            <line x1="0" y1="350"
                  x2="480" y2="350"
                  style="
                  stroke:#000;
                  stroke-width:0.5px;
                  "
                  />
            <rect x="0" y="342"
                  width="15" height="8"
                  style="
                  fill:#ffc;
                  fill-opacity:0.5;
                  stroke:none;
                  "
                  />
            <text x="0" y="349"
                  style="
                  font-size:8px;
                  "
                  >13"</text>

            <line x1="0" y1="30"
                  x2="480" y2="30"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  stroke-dasharray: 5 5;
                  "
                  />
            <line x1="30" y1="0"
                  x2="30" y2="480"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  stroke-dasharray: 5 5;
                  "
                  />
            <line x1="0" y1="450"
                  x2="480" y2="450"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  stroke-dasharray: 5 5;
                  "
                  />
            <line x1="450" y1="0"
                  x2="450" y2="480"
                  style="
                  stroke:#000;
                  stroke-width:1px;
                  stroke-dasharray: 5 5;
                  "
                  />
          </svg>
          <svg id="scenario-canvas"
               x="0" y="0" width="{{game.board.width}}" height="{{game.board.height}}"
               style="display: {{game.layers.scenario ? 'inline' : 'none'}}"
               >
            <rect ng-if="
                  menu_view === 'setup' &&
                  game.scenario.killbox
                  "
                  x="{{game.scenario.killbox}}"
                  y="{{game.scenario.killbox}}"
                  width="{{480-2*game.scenario.killbox}}"
                  height="{{480-2*game.scenario.killbox}}"
                  style="
                  fill:none;
                  stroke:#990;
                  stroke-width:0.5px;
                  "
                  />
            <rect ng-repeat="r in game.scenario.rect"
                  x="{{r.x-r.width/2}}"
                  y="{{r.y-r.height/2}}"
                  width="{{r.width}}"
                  height="{{r.height}}"
                  style="
                  fill:#CC0;
                  fill-opacity:0.3;
                  stroke:#990;
                  stroke-width:0.5px;
                  "
                  />
            <circle ng-repeat="c in game.scenario.circle"
                  cx="{{c.x}}"
                  cy="{{c.y}}"
                  r="{{c.r}}"
                  style="
                  fill:#CC0;
                  fill-opacity:0.3;
                  stroke:#990;
                  stroke-width:0.5px;
                  "
                  />
            <circle ng-repeat="o in game.scenario.objectives"
                    cx="{{o.x}}" cy="{{o.y}}"
                    r="{{factions.list.scenario.models.objectives[o.type].r}}"
                    style="
                    fill:#CC0;
                    fill-opacity:0.8;
                    stroke:#C90;
                    stroke-width:0.5px;
                    "
                    />
            <circle ng-if="
                    menu_view === 'setup'
                    "
                    ng-repeat="o in game.scenario.objectives"
                    cx="{{o.x}}" cy="{{o.y}}"
                    r="{{40+factions.list.scenario.models.objectives[o.type].r}}"
                    style="
                    fill:none;
                    stroke:#C90;
                    stroke-width:0.5px;
                    "
                    />
            <circle ng-repeat="f in game.scenario.flags"
                    cx="{{f.x}}" cy="{{f.y}}"
                    r="{{factions.list.scenario.models.flags[f.type].r}}"
                    style="
                    fill:#CC0;
                    fill-opacity:0.8;
                    stroke:#C90;
                    stroke-width:0.5px;
                    "
                    />
            <circle ng-if="
                    menu_view === 'setup'
                    "
                    ng-repeat="f in game.scenario.flags"
                    cx="{{f.x}}" cy="{{f.y}}"
                    r="{{40+factions.list.scenario.models.flags[f.type].r}}"
                    style="
                    fill:none;
                    stroke:#C90;
                    stroke-width:0.5px;
                    "
                    />
          </svg>
          <svg id="locked-template-canvas"
               x="0" y="0" width="{{game.board.width}}" height="{{game.board.height}}"
               style="display: {{game.layers.templates ? 'inline' : 'none'}}"
               >
            <circle ng-repeat="aoe in templateShowLocked('aoe')"
                    cx="{{aoe.x}}"
                    cy="{{aoe.y}}"
                    r="{{aoe.size*5}}"
                    style="
                    fill:#F90;
                    fill-opacity:0.2;
                    stroke-width:0.5px;
                    "
                    ng-style="{
                    'stroke': aoe === game.templates.active ? '#0F0' : '#C60',
                    }"
                    ng-mousedown="onTemplateMouseDown($event, aoe)"
                    />
            <polygon ng-repeat="sp in templateShowLocked('spray')"
                     points="
                     8.75,0
                     {{
                     (10-8.125*sp.size/10) + ','  + (98.34*sp.size/10) +
                     ' 10,' + (100*sp.size/10) +
                     ' ' + (10+8.125*sp.size/10) + ',' + (98.34*sp.size/10)
                     }}
                     11.25,0
                     "
                     style="
                     fill:#F90;
                     fill-opacity:0.2;
                     stroke-width:0.5px;
                     "
                     transform="
                     translate({{sp.x-10}},{{sp.y}})
                     rotate({{sp.rot-180}}, 10, 0)
                     "
                     ng-style="{
                     'stroke': sp === game.templates.active ? '#0F0' : '#C60',
                     }"
                     ng-mousedown="onTemplateMouseDown($event, sp)"
                     />
          </svg>
          <svg id="model-canvas"
               x="0" y="0" width="{{game.board.width}}" height="{{game.board.height}}"
               style="display: {{game.layers.models ? 'inline' : 'none'}}"
               >
            <circle ng-repeat="model in modelShow('color')"
                    cx="{{model.state.x}}" cy="{{model.state.y}}"
                    r="{{model.info.r+2}}"
                    style="
                    fill:{{model.state.show_color}};
                    filter: url(#aura-filter);
                    "
                    />
            <g ng-repeat="model in modelShow('charge')">
              <rect x="{{(model.state.x+model.state.charge_x)/2-model.info.r}}"
                    y="{{(model.state.y+model.state.charge_y)/2-model.state.charge_length/2}}"
                    width="{{model.info.r*2}}" height="{{model.state.charge_length}}"
                    transform="rotate(
                    {{model.state.charge_rot}},
                    {{(model.state.x+model.state.charge_x)/2}},
                    {{(model.state.y+model.state.charge_y)/2}}
                    )"
                    style="
                    fill: #999;
                    fill-opacity: 0.5;
                    stroke: #333;
                    stroke-width: 0.5px;
                    pointer-events: none;
                    "
                    />
            </g>
            <svg ng-repeat="model in game.models"
                 x="{{model.state.x - model.info.width/2}}" y="{{model.state.y - model.info.height/2}}">
              <g transform="rotate({{model.state.rot}}, {{model.info.width/2}}, {{model.info.height/2}})">
                <circle ng-mousedown="onModelMouseDown($event, model)"
                        ng-click="onModelClick($event, model)"
                        cx="{{model.info.width/2}}" cy="{{model.info.height/2}}" r="{{model.info.r}}"
                        style="
                        fill:{{model.info.color}};
                        fill-opacity:1.0;
                        stroke:black;
                        stroke-width:0.5px;
                        "
                        /> 
                <line x1="{{model.info.width/2-model.info.r}}" y1="{{model.info.height/2}}"
                      x2="{{model.info.width/2+model.info.r}}" y2="{{model.info.height/2}}"
                      style="
                      stroke:black;
                      stroke-width:0.5px;
                      pointer-events: none;
                      "
                      />
                <line x1="{{model.info.width/2}}" y1="{{model.info.height/2}}"
                      x2="{{model.info.width/2}}" y2="{{model.info.height/2-model.info.r}}"
                      style="
                      stroke:black;
                      stroke-width:0.5px;
                      pointer-events: none;
                      "
                      />
                <image ng-show="model.state.show_image"
                       x="{{model.info.img.x}}" y="{{model.info.img.y}}"
                       width="{{model.info.width}}" height="{{model.info.height}}"
                       xlink:href="{{(model.state.show_incorporeal && model.info.img.incorporeal) ? model.info.img.incorporeal : ((model.state.show_leader && model.info.img.leader) ? model.info.img.leader : model.info.img.link)}}"
                       style="pointer-events: none"
                       />
                <line ng-show="model.info.damage.total > 1"
                  x1="{{model.info.width/2-model.info.r}}" y1="{{model.info.height/2+model.info.r+1}}"
                  x2="{{model.info.width/2+model.info.r}}" y2="{{model.info.height/2+model.info.r+1}}"
                  style="
                  stroke:#0F0;
                  stroke-width:1px;
                  pointer-events: none;
                  "
                  />
                  <line ng-show="model.info.damage.total > 1"
                    x1="{{model.info.width/2-model.info.r}}" y1="{{model.info.height/2+model.info.r+1}}"
                    x2="{{model.info.width/2-model.info.r+model.info.r*2*model.state.damage.total/model.info.damage.total}}"
                    y2="{{model.info.height/2+model.info.r+1}}"
                    style="
                    stroke:#F00;
                    stroke-width:1px;
                    pointer-events: none;
                    "
                    />
                    <g ng-if="model.info.damage.field">
                      <line x1="{{model.info.width/2-model.info.r}}"
                            y1="{{model.info.height/2+model.info.r+1}}"
                            x2="{{model.info.width/2+model.info.r}}"
                            y2="{{model.info.height/2+model.info.r+1}}"
                            style="
                            stroke:#0FF;
                            stroke-width:1px;
                            pointer-events: none;
                            "
                            />
                      <line x1="{{model.info.width/2-model.info.r}}"
                            y1="{{model.info.height/2+model.info.r+1}}"
                            x2="{{model.info.width/2-model.info.r+model.info.r*2*model.state.damage.field/model.info.damage.field}}"
                            y2="{{model.info.height/2+model.info.r+1}}"
                            style="
                            stroke:#066;
                            stroke-width:1px;
                            pointer-events: none;
                            "
                            />
                    </g>
                    <image ng-repeat="e in model.effects()"
                           x="{{model.info.width/2+$index*8-8*model.effects().length/2}}"
                           y="{{model.info.height/2+model.info.r}}"
                           width="10"
                           height="10"
                           xlink:href="{{effects[e].icon}}"
                           style="pointer-events:none;"
                           />
                    <image ng-if="model.state.show_fleeing"
                           x="{{model.info.width/2-5+model.info.r*0.8}}"
                           y="{{model.info.height/2-5-model.info.r*0.8-1}}"
                           width="10"
                           height="10"
                           xlink:href="data/icons/BoltYellow.png"
                           style="pointer-events:none;"
                           />
                    <image ng-if="model.state.show_leader"
                           x="{{model.info.width/2-5+model.info.r*0.7}}"
                           y="{{model.info.height/2-5+model.info.r*0.7-1}}"
                           width="10"
                           height="10"
                           xlink:href="data/icons/Leader.png"
                           style="pointer-events:none;"
                           />
              </g>
              <g ng-if="model.state.label.length != 0"
                 transform="rotate(
                 {{game.board.zoom.flipped ? 180 : 0}},
                 {{model.info.width/2}},
                 {{model.info.height/2}})"
                 >
                <rect x="{{model.info.width/2-model.state.label.length*3.5/2-2}}"
                      y="{{
                  model.info.height/2+(((model.state.rot%360) > 90 && (model.state.rot%360) < 270) ? (game.board.zoom.flipped ? -model.info.r-7 : model.info.r) : (game.board.zoom.flipped ? model.info.r : -model.info.r-7))
                  }}"
                  width="{{model.state.label.length*3.5+4}}" height="6"
                  style="
                  fill:#333;
                  fill-opacity:0.4;
                  pointer-events: none;
                  "
                  />
                  <text x="{{model.info.width/2}}"
                        y="{{
                    model.info.height/2+(((model.state.rot%360) > 90 && (model.state.rot%360) < 270) ? (game.board.zoom.flipped ? -model.info.r-2 : model.info.r+6) : (game.board.zoom.flipped ? model.info.r+6 : -model.info.r-2))
                    }}"
                    style="
                    fill:white;
                    text-anchor:middle;
                    font-size:6px;
                    font-family:monospace;
                    pointer-events: none;
                    -webkit-user-select: none;
                    -moz-user-select:none;
                    "
                    >{{model.state.label}}</text>
              </g>
              <g ng-if="
                 model.state.unit &&
                 (model.state.show_unit ||
                  menu_view === 'units' ||
                  menu_view === 'models')
                 "
                 transform="rotate(
                 {{game.board.zoom.flipped ? 180 : 0}},
                 {{model.info.width/2}},
                 {{model.info.height/2}}
                 )"
                 >
                <rect x="{{model.info.width/2-model.info.r-9}}"
                      y="{{model.info.height/2-model.info.r-4}}"
                      width="12" height="6"
                      style="
                      fill:#333;
                      fill-opacity:0.4;
                      pointer-events: none;
                      "
                      />
                <text x="{{model.info.width/2-model.info.r+2}}"
                      y="{{model.info.height/2-model.info.r+1}}"
                      style="
                      fill:#0FF;
                      text-anchor:end;
                      font-size:6px;
                      font-family:monospace;
                      font-weight: bold;
                      pointer-events: none;
                      -webkit-user-select: none;
                      -moz-user-select:none;
                      "
                      >U{{model.state.unit}}</text>
              </g>
            </svg>
            <circle ng-repeat="id in game.update_selection"
                    cx="{{game.models[id].state.x}}"
                    cy="{{game.models[id].state.y}}"
                    r="{{game.models[id].info.r}}"
                    style="
                    fill:none;
                    stroke: #FFF;
                    stroke-width:0.75px;
                    pointer-events: none;
                    "
                    />
            <circle ng-repeat="id in game.selection"
                    cx="{{game.models[id].state.x}}"
                    cy="{{game.models[id].state.y}}"
                    r="{{game.models[id].info.r}}"
                    style="
                    fill:none;
                    stroke-width:1px;
                    pointer-events: none;
                    "
                    ng-style="{
                    'stroke': game.templates.active ? none : (modes.current.name === 'Model Target' ? '#00F' : '#0F0')
                    }"
                    />
            <circle ng-if="
                    modes.current.name === 'Model Charge' &&
                    modes.current.target
                    "
                    cx="{{modes.current.target.state.x}}"
                    cy="{{modes.current.target.state.y}}"
                    r="{{modes.current.target.info.r}}"
                    style="
                    fill:none;
                    stroke-width:1px;
                    pointer-events: none;
                    "
                    ng-style="{
                    'stroke': game.models[game.selection[0]].chargeTargetInRange(modes.current.target) ? '#0FF' : '#F00'
                    }"
                    />
            <path ng-repeat="model in modelShow('melee')"
                  d="
                  M{{model.state.x-5-model.info.r}},{{model.state.y}}
                  L{{model.state.x+5+model.info.r}},{{model.state.y}}
                  A{{5+model.info.r}},{{5+model.info.r}} 0 0,0
                  {{model.state.x-5-model.info.r}},{{model.state.y}}
                  M{{model.state.x}},{{model.state.y}}
                  L{{model.state.x}},{{model.state.y-model.info.r-5}}
                  "
                  style="
                  stroke:#000;
                  stroke-width:0.5px;
                  fill: #000;
                  fill-opacity: 0.3;
                  pointer-events: none;
                  "
                  transform="
                  rotate({{model.state.rot}},
                  {{model.state.x}},
                  {{model.state.y}})
                  "
                  />
            <path ng-repeat="model in modelShow('reach')"
                  d="
                  M{{model.state.x-20-model.info.r}},{{model.state.y}}
                  L{{model.state.x+20+model.info.r}},{{model.state.y}}
                  A{{20+model.info.r}},{{20+model.info.r}} 0 0,0
                  {{model.state.x-20-model.info.r}},{{model.state.y}}
                  M{{model.state.x}},{{model.state.y}}
                  L{{model.state.x}},{{model.state.y-model.info.r-20}}
                  "
                  style="
                  stroke:#000;
                  stroke-width:0.5px;
                  fill: #000;
                  fill-opacity: 0.3;
                  pointer-events: none;
                  "
                  transform="
                  rotate({{model.state.rot}},
                  {{model.state.x}},
                  {{model.state.y}})
                  "
                  />
            <path ng-repeat="model in modelShow('strike')"
                  d="
                  M{{model.state.x-40-model.info.r}},{{model.state.y}}
                  L{{model.state.x+40+model.info.r}},{{model.state.y}}
                  A{{40+model.info.r}},{{40+model.info.r}} 0 0,0
                  {{model.state.x-40-model.info.r}},{{model.state.y}}
                  M{{model.state.x}},{{model.state.y}}
                  L{{model.state.x}},{{model.state.y-model.info.r-40}}
                  "
                  style="
                  stroke:#000;
                  stroke-width:0.5px;
                  fill: #000;
                  fill-opacity: 0.3;
                  pointer-events: none;
                  "
                  transform="
                  rotate({{model.state.rot}},
                  {{model.state.x}},
                  {{model.state.y}})
                  "
                  />
            <circle ng-repeat="model in modelShow('control')"
                    cx="{{model.state.x}}" cy="{{model.state.y}}"
                    r="{{model.info.r+(model.info.focus || model.info.fury)*20}}"
                    style="
                    fill: #0FF;
                    fill-opacity: 0.3;
                    stroke: #099;
                    stroke-width: 1px;
                    pointer-events: none;
                    "
                    />
            <circle ng-repeat="model in showCenteredAoE()"
                    cx="{{model.state.x}}"
                    cy="{{model.state.y}}"
                    r="{{model.state.show_aoe}}"
                    style="
                    fill:#F90;
                    fill-opacity:0.2;
                    stroke:#C60;
                    stroke-width:0.5px;
                    pointer-events: none;
                    "
                    />
            <circle ng-repeat="model in showArea()"
                    cx="{{model.state.x}}"
                    cy="{{model.state.y}}"
                    r="{{model.info.r+model.state.show_area*10}}"
                    style="
                    fill:#9F9;
                    fill-opacity:0.2;
                    stroke:#6F6;
                    stroke-width:0.5px;
                    pointer-events: none;
                    "
                    />
            <g ng-repeat="model in modelShow('counter')"
               transform="rotate(
               {{game.board.zoom.flipped ? 180 : 0}},
               {{model.state.x}},
               {{model.state.y}}
               )"
               >
              <rect x="{{model.state.x-4}}" y="{{model.state.y-4}}"
                    width="8" height="9"
                    style="
                    fill:#333;
                    fill-opacity:0.7;
                    pointer-events: none;
                    "
                    />
              <text x="{{model.state.x}}" y="{{model.state.y+4}}"
                    style="
                    fill:white;
                    text-anchor:middle;
                    font-size:9px;
                    font-weight:bold;
                    font-family:Verdana, sans-serif;
                    pointer-events: none;
                    -webkit-user-select: none;
                    -moz-user-select:none;
                    "
                    >
                {{model.state.counter}}
              </text>
            </g>
            <g ng-repeat="model in modelShow('souls')"
               transform="rotate(
               {{model.state.rot}},
               {{model.state.x}},
               {{model.state.y}}
               )"
               >
              <rect x="{{model.state.x+model.info.r-1}}"
                    y="{{model.state.y-model.info.r-8}}"
                    width="10" height="10"
                    style="
                    fill:#333;
                    fill-opacity:0.7;
                    pointer-events: none;
                    "
                    />
              <image x="{{model.state.x+model.info.r-6}}"
                     y="{{model.state.y-model.info.r-10}}"
                     width="20"
                     height="20"
                     xlink:href="/data/icons/Soul.png"
                     style="
                     pointer-events: none;
                     "
                   />
              <text x="{{model.state.x+model.info.r+4}}"
                    y="{{model.state.y-model.info.r-1}}"
                    style="
                    fill:white;
                    text-anchor:middle;
                    font-size:8px;
                    font-weight:bold;
                    font-family:Verdana, sans-serif;
                    pointer-events: none;
                    -webkit-user-select: none;
                    -moz-user-select:none;
                    "
                    transform="rotate(
                    {{(game.board.zoom.flipped ? 180 : 0)-model.state.rot}},
                    {{model.state.x+model.info.r+5}},
                    {{model.state.y-model.info.r-3}}
                    )"
                    >
                {{model.state.souls}}
              </text>
            </g>
            <g ng-repeat="model in modelShow('charge')">
              <line x1="{{model.state.charge_x}}" y1="{{model.state.charge_y}}"
                    x2="{{model.state.x}}" y2="{{model.state.y}}"
                    style="
                    stroke: #0F0;
                    stroke-width: 0.5px;
                    pointer-events: none;
                    "
                    />
              <rect x="{{model.state.charge_x-1}}"
                    y="{{model.state.charge_y-8}}"
                    width="30" height="10"
                    style="
                    fill:#FFC;
                    stroke:#000;
                    stroke-width:0.5px;
                    pointer-events: none;
                    "
                    transform="rotate(
                    {{game.board.zoom.flipped ? 180 : 0}},
                    {{model.state.charge_x}},
                    {{model.state.charge_y}}
                    )"
                    />
              <text x="{{model.state.charge_x}}"
                    y="{{model.state.charge_y}}"
                    style="
                    font-size:8px;
                    pointer-events: none;
                    "
                    transform="rotate(
                    {{game.board.zoom.flipped ? 180 : 0}},
                    {{model.state.charge_x}},
                    {{model.state.charge_y}}
                    )"
                    >
                {{model.displayChargeLength()}}"
              </text>
            </g>
            <line ng-if="
                  game.update_selection.length === 1 &&
                  game.models[game.update_selection[0]].info.type !== 'objective' &&
                  game.models[game.update_selection[0]].info.type !== 'flag'
                  "
                  x1="{{game.models[game.update_selection[0]].state.x}}"
                  y1="{{game.models[game.update_selection[0]].state.y}}"
                  x2="{{game.models[game.update_selection[0]].state.x}}"
                  y2="{{game.models[game.update_selection[0]].state.y-700}}"
                  transform="
                  rotate({{game.models[game.update_selection[0]].state.rot}},
                  {{game.models[game.update_selection[0]].state.x}},
                  {{game.models[game.update_selection[0]].state.y}})
                  "
                  style="
                  stroke: white;
                  stroke-width: 0.5px;
                  pointer-events: none;
                  "
                  />
            <line ng-if="
                  game.update_selection.length === 1 &&
                  game.models[game.update_selection[0]].info.type !== 'objective' &&
                  game.models[game.update_selection[0]].info.type !== 'flag'
                  "
                  x1="{{game.models[game.update_selection[0]].state.x-700}}"
                  y1="{{game.models[game.update_selection[0]].state.y}}"
                  x2="{{game.models[game.update_selection[0]].state.x+700}}"
                  y2="{{game.models[game.update_selection[0]].state.y}}"
                  transform="
                  rotate({{game.models[game.update_selection[0]].state.rot}},
                  {{game.models[game.update_selection[0]].state.x}},
                  {{game.models[game.update_selection[0]].state.y}})
                  "
                  style="
                  stroke: white;
                  stroke-width: 0.5px;
                  pointer-events: none;
                  "
                  />
            <line ng-if="
                  game.selection.length === 1 &&
                  game.models[game.selection[0]].info.type !== 'objective' &&
                  game.models[game.selection[0]].info.type !== 'flag'
                  "
                  x1="{{game.models[game.selection[0]].state.x}}"
                  y1="{{game.models[game.selection[0]].state.y}}"
                  x2="{{game.models[game.selection[0]].state.x}}"
                  y2="{{game.models[game.selection[0]].state.y-700}}"
                  transform="
                  rotate({{game.models[game.selection[0]].state.rot}},
                  {{game.models[game.selection[0]].state.x}},
                  {{game.models[game.selection[0]].state.y}})
                  "
                  style="
                  stroke: #0F0;
                  stroke-width: 0.5px;
                  pointer-events: none;
                  "
                  />
            <line ng-if="
                  game.selection.length === 1 &&
                  game.models[game.selection[0]].info.type !== 'objective' &&
                  game.models[game.selection[0]].info.type !== 'flag'
                  "
                  x1="{{game.models[game.selection[0]].state.x-700}}"
                  y1="{{game.models[game.selection[0]].state.y}}"
                  x2="{{game.models[game.selection[0]].state.x+700}}"
                  y2="{{game.models[game.selection[0]].state.y}}"
                  transform="
                  rotate({{game.models[game.selection[0]].state.rot}},
                  {{game.models[game.selection[0]].state.x}},
                  {{game.models[game.selection[0]].state.y}})
                  "
                  style="
                  stroke: #0F0;
                  stroke-width: 0.5px;
                  pointer-events: none;
                  "
                  />
          </svg>
          <svg id="template-canvas"
               x="0" y="0" width="{{game.board.width}}" height="{{game.board.height}}"
               style="display: {{game.layers.templates ? 'inline' : 'none'}}"
               >
            <circle ng-repeat="aoe in templateShowUnlocked('aoe')"
                    cx="{{aoe.x}}"
                    cy="{{aoe.y}}"
                    r="{{aoe.size*5}}"
                    style="
                    fill:#F90;
                    fill-opacity:0.5;
                    stroke-width:0.5px;
                    "
                    ng-style="{
                    'stroke': aoe === game.templates.active ? (modes.current.name === 'Template Origin' ? '#FF0' : (modes.current.name === 'Template Target' ? '#0FF' : '#0F0')) : '#C60',
                    }"
                    ng-click="onTemplateClick($event, aoe)"
                    ng-mousedown="onTemplateMouseDown($event, aoe)"
                    />
            <line ng-show="game.templates.active.type == 'aoe' && !game.templates.active.locked"
                  x1="{{game.templates.active.x}}" y1="{{game.templates.active.y}}"
                  x2="{{game.templates.active.x}}" y2="{{game.templates.active.y-game.templates.active.size*5}}"
                  style="
                  stroke-width:0.75px;
                  marker-end:url(#aoe-direction-end);
                  "
                  ng-style="{
                  'stroke': mode_template_origin ? '#FF0' : (mode_template_target ? '#0FF' : '#0F0')
                  }"
                  transform="
                  rotate({{game.templates.active.rot}},
                  {{game.templates.active.x}},
                  {{game.templates.active.y}})
                  "
                  />
            <polygon ng-repeat="sp in templateShowUnlocked('spray')"
                     points="
                     8.75,0
                     {{
                     (10-8.125*sp.size/10) + ','  + (98.34*sp.size/10) +
                     ' 10,' + (100*sp.size/10) +
                     ' ' + (10+8.125*sp.size/10) + ',' + (98.34*sp.size/10)
                     }}
                     11.25,0
                     "
                     style="
                     fill:#F90;
                     fill-opacity:0.5;
                     stroke-width:0.5px;
                     "
                     transform="
                     translate({{sp.x-10}},{{sp.y}})
                     rotate({{sp.rot-180}}, 10, 0)
                     "
                     ng-style="{
                     'stroke': sp === game.templates.active ? (modes.current.name === 'Template Origin' ? '#FF0' : (modes.current.name === 'Template Target' ? '#0FF' : '#0F0')) : '#C60',
                     }"
                     ng-click="onTemplateClick($event, sp)"
                     ng-mousedown="onTemplateMouseDown($event, sp)"
                     />
            <circle ng-show="game.templates.active !== null && game.templates.active.origin !== null"
                    cx="{{game.templates.active.origin.state.x}}"
                    cy="{{game.templates.active.origin.state.y}}"
                    r="{{game.templates.active.origin.info.r}}"
                    style="
                    fill:none;
                    stroke:#FF0;
                    stroke-width:1px;
                    pointer-events: none;
                    "
                    />
          </svg>
          <circle ng-show="
                  modes.current.name === 'Template Create' &&
                  modes.current.type === 'aoe'
                  "
                  cx="{{modes.current.x}}"
                  cy="{{modes.current.y}}"
                  r="{{modes.current.size*5}}"
                  style="
                  fill:#F90;
                  fill-opacity:0.5;
                  stroke-width:0.5px;
                  pointer-events: none;
                  stroke: #C60;
                  "
                  />
          <polygon ng-show="
                   modes.current.name === 'Template Create' &&
                   modes.current.type === 'spray'
                   "
                   points="
                   8.75,0
                   {{
                   (10-8.125*modes.current.size/10) +
                   ','  + (98.34*modes.current.size/10) +
                   ' 10,' + (100*modes.current.size/10) +
                   ' ' + (10+8.125*modes.current.size/10) +
                   ',' + (98.34*modes.current.size/10)
                   }}
                   11.25,0
                   "
                   style="
                   fill:#F90;
                   fill-opacity:0.5;
                   stroke:#C60,
                   stroke-width:0.5px;
                   "
                   transform="
                   translate({{modes.current.x-10}},{{modes.current.y}})
                   rotate({{modes.current.rot-180}}, 10, 0)
                   "
                   />
          <svg ng-show="modes.current.name === 'Model Create'"
               ng-repeat="(i,model) in modes.current.info"
               x="{{modes.current.x + model.offset_x - model.info.width/2}}"
               y="{{modes.current.y + model.offset_y - model.info.height/2}}"
               style="pointer-events: none"
               >
            <image x="{{model.info.img.x}}"
                   y="{{model.info.img.y}}"
                   width="{{model.info.width}}"
                   height="{{model.info.height}}"
                   xlink:href="{{model.info.img.link}}"
                   />
            <circle cx="{{model.info.width/2}}"
                    cy="{{model.info.height/2}}"
                    r="{{model.info.r}}"
                    style="
                    fill:#F00;
                    fill-opacity:0.5;
                    stroke-width:1px;
                    "
                    />
          </svg>
          <rect ng-if="modes.current.name === 'Selection Drag'"
                x="{{modes.current.x}}" y="{{modes.current.y}}"
                width="{{modes.current.width}}" height="{{modes.current.height}}"
                style="
                fill: none;
                stroke:#00F;
                stroke-width:0.5px;
                " />
          <circle ng-show="
                  modes.current.group === 'Ruler' &&
                  modes.current.origin !== null
                  "
                  cx="{{modes.current.origin.state.x}}"
                  cy="{{modes.current.origin.state.y}}"
                  r="{{modes.current.origin.info.r}}"
                  style="
                  fill:none;
                  stroke:#F90;
                  stroke-width:1px;
                  pointer-events: none;
                  "
                  />
          <circle ng-show="
                  modes.current.group === 'Ruler' &&
                  modes.current.target !== null
                  "
                  cx="{{modes.current.target.state.x}}"
                  cy="{{modes.current.target.state.y}}"
                  r="{{modes.current.target.info.r}}"
                  style="
                  fill:none;
                  stroke-width:1px;
                  pointer-events: none;
                  "
                  ng-style="{
                  'stroke': modes.current.target_in_range ? '#F0C' : '#F00'
                  }"
                  />
          <g ng-show="game.ruler.state.active"
             style="pointer-events: none"
             >
            <line x1="{{game.ruler.state.x1}}" y1="{{game.ruler.state.y1}}"
                  x2="{{game.ruler.state.x2}}" y2="{{game.ruler.state.y2}}"
                  style="
                  stroke-width:1px;
                  marker-start:url(#ruler-start);
                  marker-end:url(#ruler-end);
                  "
                  ng-style="{
                  'stroke': (modes.current.name === 'Ruler Target') ? '#F09' : (modes.current.name === 'Ruler Origin' ? '#F90' : '#0FF')
                  }"
                  />
            <rect x="{{(game.ruler.state.x2-game.ruler.state.x1)/2+game.ruler.state.x1-2.5}}"
                  y="{{(game.ruler.state.y2-game.ruler.state.y1)/2+game.ruler.state.y1-4}}"
                  width="30" height="10"
                  style="
                  fill:#FFC;
                  stroke:#000;
                  stroke-width:0.5px;
                  "
                  transform="rotate(
                  {{game.board.zoom.flipped ? 180 : 0}},
                  {{(game.ruler.state.x2-game.ruler.state.x1)/2+game.ruler.state.x1}},
                  {{(game.ruler.state.y2-game.ruler.state.y1)/2+game.ruler.state.y1+4}}
                  )"
                  />
            <text x="{{(game.ruler.state.x2-game.ruler.state.x1)/2+game.ruler.state.x1}}"
                  y="{{(game.ruler.state.y2-game.ruler.state.y1)/2+game.ruler.state.y1+4}}"
                  style="
                  font-size:8px;
                  "
                  transform="rotate(
                  {{game.board.zoom.flipped ? 180 : 0}},
                  {{(game.ruler.state.x2-game.ruler.state.x1)/2+game.ruler.state.x1}},
                  {{(game.ruler.state.y2-game.ruler.state.y1)/2+game.ruler.state.y1+4}}
                  )"
                  >
              {{game.ruler.state.length}}"
            </text>
          </g>
          <line ng-show="game.los.state.active"
                x1="{{game.los.state.x1}}" y1="{{game.los.state.y1}}"
                x2="{{game.los.state.x2}}" y2="{{game.los.state.y2}}"
                style="
                stroke: #0F0;
                stroke-width:0.5px;
                pointer-events: none;
                "
                />
          <g ng-show="modes.current.name === 'Model Drag'"
             style="pointer-events: none"
             >
            <line x1="{{modes.current.start_x}}" y1="{{modes.current.start_y}}"
                  x2="{{modes.current.end_x}}" y2="{{modes.current.end_y}}"
                  style="
                  stroke:#0FF;
                  stroke-width:1px;
                  marker-start:url(#ruler-start);
                  marker-end:url(#ruler-end);
                  "
                  />
            <rect x="{{(modes.current.end_x-modes.current.start_x)/2+modes.current.start_x-2.5}}"
                  y="{{(modes.current.end_y-modes.current.start_y)/2+modes.current.start_y-4}}"
                  width="30" height="10"
                  style="
                  fill:#FFC;
                  stroke:#000;
                  stroke-width:0.5px;
                  "
                  transform="rotate(
                  {{game.board.zoom.flipped ? 180 : 0}},
                  {{(modes.current.end_x-modes.current.start_x)/2+modes.current.start_x}},
                  {{(modes.current.end_y-modes.current.start_y)/2+modes.current.start_y+4}}
                  )"
                  />
            <text x="{{(modes.current.end_x-modes.current.start_x)/2+modes.current.start_x}}"
                  y="{{(modes.current.end_y-modes.current.start_y)/2+modes.current.start_y+4}}"
                  style="
                  font-size:8px;
                  "
                  transform="rotate(
                  {{game.board.zoom.flipped ? 180 : 0}},
                  {{(modes.current.end_x-modes.current.start_x)/2+modes.current.start_x}},
                  {{(modes.current.end_y-modes.current.start_y)/2+modes.current.start_y+4}}
                  )"
                  >
              {{modes.current.length}}"
            </text>
          </g>
        </svg>
        </div>
        </div>
      </td>
      <td ng-show="game.id"
          valign="top">
        <div style="
             border:1px solid black;
             height:{{game.board.window.height}}px;
             max-height:{{game.board.window.height}}px;
             width:100px;
             max-width:125px;
             text-align:center;
             margin-right:5px;
             "
             ng-include="'partials/modeBox.html'">
        </div>
      </td>
      <td valign="top">
        <div style="vertical-align:top;">
          <strong>Game Id :</strong> {{game.id ? game.id : game.public_id}}
          <strong>Player1 :</strong> {{game.player1.name}}
          <strong>Player2 :</strong> {{game.player2.name}}<br />
          <button ng-style="{
                  'background-color': menu_view === 'main' ? '#6F6' : 'none'
                  }"
                  ng-click="menu_view = 'main'">Main</button>
          <button ng-style="{
                  'background-color': menu_view === 'units' ? '#6F6' : 'none'
                  }"
                  ng-click="menu_view = 'units'">Units</button>
          <button ng-show="game.id"
                  ng-style="{
                  'background-color': menu_view === 'models' ? '#6F6' : 'none'
                  }"
                  ng-click="menu_view = 'models'">Manage Models</button>
          <button ng-style="{
                  'background-color': menu_view === 'setup' ? '#6F6' : 'none'
                  }"
                  ng-click="menu_view = 'setup'">Setup</button>
          <button ng-style="{
                  'background-color': menu_view === 'layers' ? '#6F6' : 'none'
                  }"
                  ng-click="menu_view = 'layers'">Layers</button>
          <button ng-style="{
                  'background-color': menu_view === 'games' ? '#6F6' : 'none'
                  }"
                  ng-click="menu_view = 'games'">Online</button>
          <button ng-click="doGoHome()">Home</button>
          <div ng-show="menu_view === 'main'">
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/toolsBox.html'">
            </div>
            <div style="border:1px solid black;max-height:125px;overflow-y:scroll;"
                 ng-include="'partials/chatBox.html'">
            </div>
            <div style="border:1px solid black;overflow-y:scroll;"
                 ng-show="game.selection.length === 1"
                 ng-include="'partials/modelViewBox.html'">
            </div>
            <div ng-if="game.id"
                 style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/commandBox.html'">
            </div>
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/backupBox.html'">
            </div>
          </div>
          <div ng-if="menu_view === 'units'">
            <div style="border:1px solid black;max-height:700px;overflow-y:scroll;"
                 ng-include="'partials/unitsBox.html'">
            </div>
          </div>
          <div ng-if="menu_view === 'setup'">
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/boardsBox.html'">
            </div>
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/scenariosBox.html'">
            </div>
          </div>
          <div ng-show="menu_view === 'layers'">
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/layersBox.html'">
            </div>
          </div>
          <div ng-if="game.id"
               ng-show="menu_view === 'models'">
            <div style="border:1px solid black;max-height:600px;overflow-y:scroll;"
                 ng-include="'partials/createBox.html'">
            </div>
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/importBox.html'">
            </div>
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/importFKBox.html'">
            </div>
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/dropBinBox.html'">
            </div>
          </div>
          <div ng-show="menu_view === 'games'">
            <strong>User Id :</strong> {{user.id}}
            <strong>User Name :</strong> {{user.name}}
            <div style="border:1px solid black;max-height:600px;overflow-y:scroll;"
                 ng-include="'partials/usersBox.html'">
            </div>
            <div style="border:1px solid black;max-height:200px;overflow-y:scroll;"
                 ng-include="'partials/gamesBox.html'">
            </div>
          </div>
        </div>
      </td>
    </tr>
  </table>
  <div style="
       position:absolute;
       right: 0;
       bottom: 0;
       border: 1px solid black;
       background-color: #CCF;
       padding: 2px 3em;
       "
       ng-show="user.last_chat"
       >
      {{users.list[user.last_chat.from].name}} &#8594;
      {{user.last_chat.text}}
  </div>
</div>
